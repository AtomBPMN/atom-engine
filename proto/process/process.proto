/*
This file is part of the AtomBPMN (R) project.
Copyright (c) 2025 Matreska Market LLC (ООО «Matreska Market»).
Authors: Matreska Team.

This project is dual-licensed under AGPL-3.0 and AtomBPMN Commercial License.
*/

syntax = "proto3";

package atom.process.v1;

option go_package = "atom-engine/proto/process/processpb";

// Process service for BPMN process operations
service ProcessService {
  // Start a process instance
  rpc StartProcessInstance(StartProcessInstanceRequest) returns (StartProcessInstanceResponse);
  
  // Get process instance status
  rpc GetProcessInstanceStatus(GetProcessInstanceStatusRequest) returns (GetProcessInstanceStatusResponse);
  
  // Cancel process instance
  rpc CancelProcessInstance(CancelProcessInstanceRequest) returns (CancelProcessInstanceResponse);
  
  // List process instances
  rpc ListProcessInstances(ListProcessInstancesRequest) returns (ListProcessInstancesResponse);
  
  // List tokens
  rpc ListTokens(ListTokensRequest) returns (ListTokensResponse);
  
  // Get token details
  rpc GetTokenStatus(GetTokenStatusRequest) returns (GetTokenStatusResponse);
  
  // Get complete process instance information
  rpc GetProcessInstanceInfo(GetProcessInstanceInfoRequest) returns (GetProcessInstanceInfoResponse);
}

// Request for starting process instance
message StartProcessInstanceRequest {
  string process_id = 1;
  map<string, string> variables = 2;
}

// Response for starting process instance
message StartProcessInstanceResponse {
  string instance_id = 1;
  string status = 2;
  bool success = 3;
  string message = 4;
}

// Request for process instance status
message GetProcessInstanceStatusRequest {
  string instance_id = 1;
}

// Response for process instance status
message GetProcessInstanceStatusResponse {
  string instance_id = 1;
  string status = 2;
  string current_activity = 3;
  map<string, string> variables = 4;
  int64 started_at = 5;
  int64 updated_at = 6;
}

// Request for canceling process instance
message CancelProcessInstanceRequest {
  string instance_id = 1;
  string reason = 2;
}

// Response for canceling process instance
message CancelProcessInstanceResponse {
  string instance_id = 1;
  bool success = 2;
  string message = 3;
}

// Request for listing process instances
message ListProcessInstancesRequest {
  string status_filter = 1;    // Optional status filter (ACTIVE, COMPLETED, CANCELLED)
  int32 limit = 2;             // Optional limit for number of results (deprecated, use page_size)
  string process_key_filter = 3; // Optional filter by process key
  int32 page_size = 4;         // Number of items per page (default: 20)
  int32 page = 5;              // Page number (1-based, default: 1)
  string sort_by = 6;          // Sort field (default: "started_at")
  string sort_order = 7;       // Sort order: "ASC" or "DESC" (default: "DESC")
}

// Response for listing process instances
message ListProcessInstancesResponse {
  repeated ProcessInstanceInfo instances = 1;
  bool success = 2;
  string message = 3;
  int32 total_count = 4;        // Total number of process instances matching filters
  int32 page = 5;               // Current page number
  int32 page_size = 6;          // Number of items per page
  int32 total_pages = 7;        // Total number of pages
}

// Process instance information
message ProcessInstanceInfo {
  string instance_id = 1;
  string process_key = 2;
  string status = 3;
  string current_activity = 4;
  int64 started_at = 5;
  int64 updated_at = 6;
  map<string, string> variables = 7;
}

// Request for listing tokens
message ListTokensRequest {
  string instance_id_filter = 1;  // Optional filter by process instance ID
  string state_filter = 2;        // Optional filter by token state (ACTIVE, COMPLETED, CANCELLED)
  int32 limit = 3;                // Optional limit for number of results (deprecated, use page_size)
  int32 page_size = 4;            // Number of items per page (default: 20)
  int32 page = 5;                 // Page number (1-based, default: 1)
  string sort_by = 6;             // Sort field (default: "created_at")
  string sort_order = 7;          // Sort order: "ASC" or "DESC" (default: "DESC")
}

// Response for listing tokens
message ListTokensResponse {
  repeated TokenInfo tokens = 1;
  bool success = 2;
  string message = 3;
  int32 total_count = 4;          // Total number of tokens matching filters
  int32 page = 5;                 // Current page number
  int32 page_size = 6;            // Number of items per page
  int32 total_pages = 7;          // Total number of pages
}

// Token information
message TokenInfo {
  string token_id = 1;
  string process_instance_id = 2;
  string process_key = 3;
  string current_element_id = 4;
  string state = 5;
  string waiting_for = 6;
  int64 created_at = 7;
  int64 updated_at = 8;
  map<string, string> variables = 9;
}

// Request for token status
message GetTokenStatusRequest {
  string token_id = 1;
}

// Response for token status
message GetTokenStatusResponse {
  TokenInfo token = 1;
  bool success = 2;
  string message = 3;
}

// Request for process instance complete information
message GetProcessInstanceInfoRequest {
  string instance_id = 1;
}

// Timer information for process instance
message ProcessTimerInfo {
  string timer_id = 1;
  string element_id = 2;
  string timer_type = 3;
  string status = 4;
  int64 scheduled_at = 5;
  int64 remaining_seconds = 6;
  string time_duration = 7;
  string time_cycle = 8;
}

// Job information for process instance
message ProcessJobInfo {
  string key = 1;
  string type = 2;
  string worker = 3;
  string element_id = 4;
  string status = 5;
  int32 retries = 6;
  int64 created_at = 7;
  string error_message = 8;
}

// Message subscription information for process instance
message ProcessMessageSubscriptionInfo {
  string id = 1;
  string message_name = 2;
  string correlation_key = 3;
  string start_event_id = 4;
  bool is_active = 5;
  int64 created_at = 6;
}

// Buffered message information for process instance
message ProcessBufferedMessageInfo {
  string id = 1;
  string name = 2;
  string correlation_key = 3;
  string element_id = 4;
  int64 published_at = 5;
  int64 expires_at = 6;
  string reason = 7;
}

// Incident information for process instance
message ProcessIncidentInfo {
  string id = 1;
  string type = 2;
  string status = 3;
  string message = 4;
  string error_code = 5;
  string element_id = 6;
  string job_key = 7;
  int64 created_at = 8;
}

// Detailed information for external services
message ExternalServicesInfo {
  repeated ProcessTimerInfo timers = 1;
  repeated ProcessJobInfo jobs = 2;
  repeated ProcessMessageSubscriptionInfo message_subscriptions = 3;
  repeated ProcessBufferedMessageInfo buffered_messages = 4;
  repeated ProcessIncidentInfo incidents = 5;
}

// Response for process instance complete information
message GetProcessInstanceInfoResponse {
  bool success = 1;
  string message = 2;
  
  // Process basic info
  string instance_id = 3;
  string process_key = 4;
  string status = 5;
  string current_activity = 6;
  int64 started_at = 7;
  int64 updated_at = 8;
  map<string, string> variables = 9;
  
  // Related data
  repeated TokenInfo tokens = 10;
  ExternalServicesInfo external_services = 11;
}
